kind: pipeline
type: kubernetes
name: default

steps:
  - name: build
    image: quay.io/containers/buildah:latest
    environment:
      # tell buildah to just use chroot isolation
      # we donâ€™t need to run with extra isolation because we are already running within a container
      # also, this way we don't need CAP_SYS_ADMIN, which we'd otherwise need to make namespaces
      _BUILDAH_STARTED_IN_USERNS: ""
      BUILDAH_ISOLATION: "chroot"
      # get registry credentials from secret
      REGISTRY_USERNAME:
        from_secret: registry_username
      REGISTRY_PASSWORD:
        from_secret: registry_password
    commands:
      - buildah login -u $REGISTRY_USERNAME -p $REGISTRY_PASSWORD registry.hubbe.club
      - buildah bud --tag registry.hubbe.club/hubbot:latest .
      - buildah push registry.hubbe.club/hubbot:latest
    resources:
      requests:
        cpu: 100
        memory: 100MiB
      limits:
        cpu: 500
        memory: 500MiB
